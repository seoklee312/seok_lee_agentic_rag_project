<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuicX - Agentic RAG Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 25px;
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        /* Presentation Slide Styling */
        #slideContent {
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        #slideContent::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        .result {
            margin-top: 25px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .result h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }
        
        .answer {
            line-height: 1.8;
            color: #555;
            white-space: pre-wrap;
        }
        
        .metadata {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            font-size: 12px;
            margin-right: 8px;
            font-weight: 600;
        }
        
        .feedback-buttons {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .feedback-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .feedback-btn.positive:hover {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .feedback-btn.negative:hover {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-container h5 {
            margin: 0 0 10px 0;
            font-size: 0.95em;
            opacity: 0.9;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }
        
        .message.user {
            justify-content: flex-start;
        }
        
        .message.assistant {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 15px;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: white;
            border: 2px solid #e0e0e0;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content * {
            color: white !important;
        }
        
        .message-meta {
            font-size: 11px;
            color: rgba(255,255,255,0.9) !important;
            margin-top: 5px;
        }
        
        .message.user .message-meta {
            color: #999;
        }
        
        .source-item {
            position: relative;
            cursor: help;
        }
        
        .source-item:hover .source-tooltip {
            display: block;
        }
        
        .source-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            max-width: 300px;
            z-index: 1000;
            margin-bottom: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .metrics-box {
            background: #fff9c4 !important;
            border: 2px solid #ffd54f;
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .regenerate-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .regenerate-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            width: fit-content;
            border-bottom-right-radius: 5px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.95em;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .doc-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .doc-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .doc-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102,126,234,0.2);
        }
        
        .doc-id {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .doc-content {
            color: #555;
            line-height: 1.6;
        }
        
        .section-divider {
            margin: 30px 0;
            padding: 30px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 25px;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶â QuicX</h1>
            <p style="font-size: 0.95em; margin-bottom: 12px;">
                Agentic RAG with Self-Correcting Retrieval & Real-Time Web Search
            </p>
            <p style="font-size: 0.75em; opacity: 0.8; max-width: 900px; margin: 0 auto; line-height: 1.5;">
                Intelligent agents route queries ‚Üí retrieve & grade documents ‚Üí self-correct if needed ‚Üí validate answers. Combines private knowledge with live web data for accurate, hallucination-free responses.
            </p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('query')">üí¨ Query</button>
            <button class="tab" onclick="switchTab('crud')">üìÑ CRUD</button>
            <button class="tab" onclick="switchTab('feedback')">‚≠ê Feedback</button>
            <button class="tab" onclick="switchTab('metrics')">üìä Metrics</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('lld')">üìã LLD</button>
        </div>
        
        <!-- Query Tab -->
        <div id="query-tab" class="tab-content active">
            <div class="card" style="height: 700px; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ü¶â</span>
                            QuicX
                        </h3>
                        <div id="statusBox" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; font-size: 0.85em;">
                            <span id="statusIndicator">üü¢</span>
                            <span id="statusText" style="color: #0369a1; font-weight: 600;">Connected</span>
                        </div>
                        <!-- Live Flow Indicator (moved here) -->
                        <div id="flowIndicator" style="display: none; background: linear-gradient(90deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 600;">
                            <span id="flowText">üéØ Routing query...</span>
                        </div>
                    </div>
                    <button onclick="toggleDarkMode()" style="padding: 8px 16px; font-size: 0.9em; background: transparent; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                        <span id="themeIcon">üåô</span> Dark Mode
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" style="flex: 1; overflow-y: auto; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 15px;">ü¶â</div>
                        <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">Agentic RAG Assistant</div>
                        <div style="font-size: 0.9em; line-height: 1.6;">
                            <strong>How it works:</strong><br>
                            üéØ Route ‚Üí üìö Retrieve ‚Üí ‚úÖ Grade ‚Üí üîÑ Self-Correct ‚Üí üí¨ Generate ‚Üí üõ°Ô∏è Validate<br><br>
                            <strong>Powered by:</strong><br>
                            üìö Private documents (69 articles) ‚Ä¢ üåê Live web search ‚Ä¢ üß† Semantic cache ‚Ä¢ ‚è±Ô∏è Temporal filtering
                        </div>
                        <div style="margin-top: 20px; font-size: 0.85em; color: #bbb;">
                            Try: "What's the latest basketball news?" or "Tell me about recent events"
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div style="position: relative;">
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <div style="display: flex; gap: 12px; margin-bottom: 8px; font-size: 0.85em; flex-wrap: wrap;">
                                <!-- Detail Level -->
                                <div style="display: flex; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="detailLevel" value="brief" style="margin: 0;">
                                        <span>Brief</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="detailLevel" value="normal" checked style="margin: 0;">
                                        <span>Normal</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="detailLevel" value="detailed" style="margin: 0;">
                                        <span>Detailed</span>
                                    </label>
                                </div>
                                
                                <!-- Response Style -->
                                <div style="display: flex; gap: 8px; border-left: 2px solid #ddd; padding-left: 12px;">
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="responseStyle" value="factual" style="margin: 0;">
                                        <span>üìä Factual</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px;">
                                        <input type="radio" name="responseStyle" value="natural" checked style="margin: 0;">
                                        <span>üí¨ Natural</span>
                                    </label>
                                </div>
                                
                                <!-- Agentic Mode Toggle -->
                                <div style="display: flex; gap: 8px; border-left: 2px solid #ddd; padding-left: 12px;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="agenticMode" style="margin: 0; width: 16px; height: 16px; cursor: pointer;">
                                        <span style="font-weight: 600; color: #667eea;">üéØ Agentic Mode</span>
                                        <span style="font-size: 0.75em; color: #999;">(+grade, rewrite, validate)</span>
                                    </label>
                                </div>
                            </div>
                            <textarea 
                                id="question" 
                                placeholder="Type your message..."
                                style="width: 100%; min-height: 60px; max-height: 120px;"
                            ></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="clearChat()" title="Clear Chat" style="width: 40px; height: 28px; padding: 2px; font-size: 16px; background: #f3f4f6; border: 1px solid #d1d5db;">
                                üóëÔ∏è
                            </button>
                            <button id="submitBtn" onclick="submitQuery()" style="width: 120px; height: 60px;">
                                üöÄ Send
                            </button>
                        </div>
                    </div>
                    
                    <!-- Suggestions Dropdown -->
                    <div id="suggestions" style="
                        display: none;
                        position: absolute;
                        bottom: 100%;
                        left: 0;
                        right: 130px;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 10px;
                        box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        margin-bottom: 5px;
                    "></div>
                </div>
            </div>
        </div>
        

        <div id="lld-tab" class="tab-content">
            <div class="card" style="padding: 0; height: 90vh; display: flex; flex-direction: column;">
                <div style="padding: 20px 30px; border-bottom: 2px solid #f0f0f0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.6em;">üìã Low-Level Design (LLD)</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Agentic RAG System - Technical Specification</p>
                    </div>
                    <a href="/static/AGENTIC_RAG_LLD.md" download style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9em;">
                        üì• Download
                    </a>
                </div>
                
                <div style="flex: 1; overflow-y: auto; padding: 40px; background: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word;">
                        <div style="text-align: center; margin-bottom: 40px; padding-bottom: 30px; border-bottom: 3px solid #667eea;">
                            <h1 style="font-size: 2.5em; color: #1a1a1a; margin-bottom: 10px;">Agentic RAG System</h1>
                            <h2 style="font-size: 1.5em; color: #667eea; margin-bottom: 15px;">Low-Level Design (LLD)</h2>
                            <p style="color: #666; font-size: 1.1em;">Production-Grade AI Question-Answering System</p>
                            <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Version 1.0 | February 2026</p>
                        </div>
                        
                        <div id="lldContent" style="color: #333; font-size: 0.95em; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">
                            <p style="text-align: center; color: #999; padding: 60px 20px;">
                                <span style="font-size: 3em;">üìÑ</span><br><br>
                                Loading LLD document...<br>
                                <small>Click "Download" button above to view the full document</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metrics Tab -->
        <div id="metrics-tab" class="tab-content">
            <!-- KPI Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Total Queries</div>
                    <div id="kpi-total-queries" style="font-size: 2em; font-weight: 700; color: #667eea;">0</div>
                    <div id="kpi-queries-change" style="font-size: 0.75em; color: #28a745; margin-top: 5px;">+0%</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Avg Latency</div>
                    <div id="kpi-avg-latency" style="font-size: 2em; font-weight: 700; color: #764ba2;">0ms</div>
                    <div id="kpi-latency-change" style="font-size: 0.75em; color: #28a745; margin-top: 5px;">-0%</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Success Rate</div>
                    <div id="kpi-success-rate" style="font-size: 2em; font-weight: 700; color: #28a745;">0%</div>
                    <div id="kpi-success-change" style="font-size: 0.75em; color: #28a745; margin-top: 5px;">+0%</div>
                </div>
                <div class="card" style="padding: 20px; text-align: center;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Cache Hit Rate</div>
                    <div id="kpi-cache-rate" style="font-size: 2em; font-weight: 700; color: #ff6b6b;">0%</div>
                    <div id="kpi-cache-change" style="font-size: 0.75em; color: #28a745; margin-top: 5px;">+0%</div>
                </div>
            </div>

            <!-- Time Window Selector -->
            <div class="card" style="padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight: 600; color: #555;">Time Window:</span>
                    <button onclick="updateMetricsWindow(1)" class="time-btn active" data-hours="1" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em;">1 Hour</button>
                    <button onclick="updateMetricsWindow(6)" class="time-btn" data-hours="6" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em;">6 Hours</button>
                    <button onclick="updateMetricsWindow(24)" class="time-btn" data-hours="24" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.9em;">24 Hours</button>
                    <label style="margin-left: auto; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.9em; color: #555;">Auto-refresh (10s)</span>
                    </label>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px;">Query Volume (TPS)</h3>
                    <canvas id="tpsChart" style="max-height: 250px;"></canvas>
                </div>
                <div class="card">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px;">Response Time (ms)</h3>
                    <canvas id="latencyChart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px;">Success Rate (%)</h3>
                    <canvas id="successChart" style="max-height: 250px;"></canvas>
                </div>
                <div class="card">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px;">Cache Performance (%)</h3>
                    <canvas id="cacheChart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <!-- Step Latency Breakdown -->
            <div class="card">
                <h3 style="font-size: 1.1em; margin-bottom: 15px;">Step-by-Step Latency Breakdown</h3>
                <canvas id="stepLatencyChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Metrics Table -->
            <div class="card">
                <h3 style="font-size: 1.1em; margin-bottom: 15px;">Detailed Metrics</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Metric</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Current</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">P50</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">P99</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600;">Count</th>
                            </tr>
                        </thead>
                        <tbody id="metricsTableBody">
                            <tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">Loading metrics...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentQueryId = null;
        let feedbackChart = null;
        let conversationHistory = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Find and activate the clicked tab button
            document.querySelectorAll('.tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
                    t.onclick.toString().includes(tabName)) {
                    t.classList.add('active');
                }
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'design') initPresentationIfNeeded();
            if (tabName === 'lld') loadLLDContent();
            if (tabName === 'feedback') loadFeedbackStats();
            if (tabName === 'metrics') {
                setTimeout(() => {
                    loadSystemStats();
                    // Restart auto-refresh if toggle is checked
                    const toggle = document.getElementById('autoRefreshToggle');
                    if (toggle && toggle.checked) {
                        toggleAutoRefresh();
                    }
                }, 100);
            } else {
                // Stop auto-refresh when leaving metrics tab
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
            if (tabName === 'crud') loadDocuments();
            if (tabName === 'settings') loadSettings();
        }
        
        function loadSettings() {
            // Load current settings from backend or localStorage
            const settings = JSON.parse(localStorage.getItem('precisionSettings') || '{}');
            
            // Set checkboxes
            document.getElementById('semanticReranking').checked = settings.semantic_reranking_enabled !== false;
            document.getElementById('deduplication').checked = settings.deduplication_enabled !== false;
            document.getElementById('groundingVerification').checked = settings.grounding_verification_enabled !== false;
            document.getElementById('citationVerification').checked = settings.citation_verification_enabled !== false;
            document.getElementById('confidenceScoring').checked = settings.confidence_scoring_enabled !== false;
            document.getElementById('queryExpansion').checked = settings.query_expansion_enabled !== false;
            document.getElementById('temporalFiltering').checked = settings.temporal_filtering_enabled !== false;
            document.getElementById('multiStageRetrieval').checked = settings.multi_stage_retrieval_enabled !== false;
            document.getElementById('enhancedClassification').checked = settings.enhanced_classification_enabled !== false;
            document.getElementById('credibilityScoring').checked = settings.credibility_scoring_enabled !== false;
            
            updateSettings();
        }
        
        function updateSettings() {
            const settings = {
                semantic_reranking_enabled: document.getElementById('semanticReranking').checked,
                deduplication_enabled: document.getElementById('deduplication').checked,
                grounding_verification_enabled: document.getElementById('groundingVerification').checked,
                citation_verification_enabled: document.getElementById('citationVerification').checked,
                confidence_scoring_enabled: document.getElementById('confidenceScoring').checked,
                query_expansion_enabled: document.getElementById('queryExpansion').checked,
                temporal_filtering_enabled: document.getElementById('temporalFiltering').checked,
                multi_stage_retrieval_enabled: document.getElementById('multiStageRetrieval').checked,
                enhanced_classification_enabled: document.getElementById('enhancedClassification').checked,
                credibility_scoring_enabled: document.getElementById('credibilityScoring').checked
            };
            
            // Calculate estimated metrics
            let precision = 85; // Base
            let speed = 1.2; // Base seconds
            let cost = 0; // Base
            
            if (settings.semantic_reranking_enabled) { precision += 23; cost += 11; }
            if (settings.deduplication_enabled) { precision += 34; }
            if (settings.grounding_verification_enabled) { precision += 67; cost += 30; }
            if (settings.citation_verification_enabled) { precision += 89; cost += 30; }
            if (settings.confidence_scoring_enabled) { precision += 41; cost += 20; }
            if (settings.query_expansion_enabled) { precision += 10; }
            if (settings.temporal_filtering_enabled) { precision += 15; }
            if (settings.multi_stage_retrieval_enabled) { precision += 8; speed *= 0.5; }
            if (settings.enhanced_classification_enabled) { precision += 12; }
            if (settings.credibility_scoring_enabled) { precision += 7; }
            
            precision = Math.min(99.9, precision);
            
            document.getElementById('configSummary').innerHTML = `
                <strong>Precision:</strong> ${precision.toFixed(1)}% | 
                <strong>Speed:</strong> ${speed.toFixed(1)}s avg | 
                <strong>Cost:</strong> $${cost}/month
            `;
        }
        
        async function saveSettings() {
            const settings = {
                semantic_reranking_enabled: document.getElementById('semanticReranking').checked,
                deduplication_enabled: document.getElementById('deduplication').checked,
                grounding_verification_enabled: document.getElementById('groundingVerification').checked,
                citation_verification_enabled: document.getElementById('citationVerification').checked,
                confidence_scoring_enabled: document.getElementById('confidenceScoring').checked,
                query_expansion_enabled: document.getElementById('queryExpansion').checked,
                temporal_filtering_enabled: document.getElementById('temporalFiltering').checked,
                multi_stage_retrieval_enabled: document.getElementById('multiStageRetrieval').checked,
                enhanced_classification_enabled: document.getElementById('enhancedClassification').checked,
                credibility_scoring_enabled: document.getElementById('credibilityScoring').checked
            };
            
            // Save to localStorage
            localStorage.setItem('precisionSettings', JSON.stringify(settings));
            
            // TODO: Send to backend
            // await fetch('/api/settings', { method: 'POST', body: JSON.stringify(settings) });
            
            alert('‚úÖ Settings saved! Changes will apply to next query.');
        }

        function addMessage(role, content, metadata = null) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove welcome message if exists
            if (chatMessages.children.length === 1 && chatMessages.children[0].style.textAlign === 'center') {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            // Format markdown-like content
            let formattedContent = content
                .replace(/^# (.+)$/gm, '<h1 style="font-size: 1.4em; font-weight: 600; margin: 10px 0;">$1</h1>')
                .replace(/^## (.+)$/gm, '<h2 style="font-size: 1.2em; font-weight: 600; margin: 8px 0;">$1</h2>')
                .replace(/^### (.+)$/gm, '<h3 style="font-size: 1.1em; font-weight: 600; margin: 6px 0;">$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li style="margin-left: 20px;">$1</li>')
                .replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 10px 0;">')
                .replace(/\n\n/g, '</p><p style="margin: 8px 0;">')
                .replace(/^\n/g, '');
            
            formattedContent = '<p style="margin: 8px 0;">' + formattedContent + '</p>';
            
            let sourcesHtml = '';
            if (metadata && metadata.sources && metadata.sources.length > 0) {
                const webSources = metadata.sources.filter(s => s.type === 'web');
                const docSources = metadata.sources.filter(s => s.type === 'document');
                
                if (webSources.length > 0 || docSources.length > 0) {
                    sourcesHtml = '<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.85em; color: #666;">';
                    sourcesHtml += '<div style="font-weight: 600; margin-bottom: 5px;">Sources:</div>';
                    
                    webSources.forEach((src, i) => {
                        sourcesHtml += `<div style="margin: 3px 0;">üåê <a href="${src.url}" target="_blank" style="color: #667eea; text-decoration: none;">${src.title}</a></div>`;
                    });
                    
                    docSources.forEach((src, i) => {
                        sourcesHtml += `<div style="margin: 3px 0;">üìÑ Document ${src.doc_id}</div>`;
                    });
                    
                    sourcesHtml += '</div>';
                }
            }
            
            let metaHtml = '';
            if (metadata) {
                metaHtml = `<div style="font-size: 0.8em; color: #999; margin-top: 8px;">${metadata.web_search_used ? 'üåê Web+Docs' : 'üìö Docs'} ‚Ä¢ ${metadata.processing_time_ms}ms</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${formattedContent}
                    ${metaHtml}
                    ${sourcesHtml}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        // Query suggestions
        let debounceTimer;
        const questionInput = document.getElementById('question');
        const suggestionsDiv = document.getElementById('suggestions');
        
        questionInput.addEventListener('input', async (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`http://localhost:8000/v1/suggestions?q=${encodeURIComponent(query)}&limit=5`);
                    const data = await response.json();
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        showSuggestions(data.suggestions);
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Suggestions error:', error);
                }
            }, 300);
        });
        
        function showSuggestions(suggestions) {
            suggestionsDiv.innerHTML = suggestions.map(sug => `
                <div style="
                    padding: 12px 15px;
                    cursor: pointer;
                    border-bottom: 1px solid #eee;
                    transition: background 0.2s;
                " 
                onmouseover="this.style.background='#f5f5f5'"
                onmouseout="this.style.background='white'"
                onclick="selectSuggestion('${sug.text.replace(/'/g, "\\'")}')">
                    <div style="font-weight: 500; color: #333;">${sug.text}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 2px;">
                        ${sug.reason === 'recent' ? 'üïê Recent' : 
                          sug.reason === 'popular' ? 'üî• Popular' : 
                          sug.reason === 'follow-up' ? 'üí° Follow-up' : '‚ú® Suggested'}
                    </div>
                </div>
            `).join('');
            suggestionsDiv.style.display = 'block';
        }
        
        function selectSuggestion(text) {
            questionInput.value = text;
            suggestionsDiv.style.display = 'none';
            questionInput.focus();
        }
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!questionInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        async function submitQuery() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            if (!question) return;

            const btn = document.getElementById('submitBtn');
            const startTime = Date.now();
            
            // Add user message
            addMessage('user', question);
            conversationHistory.push({ role: 'user', content: question });
            
            // Clear input
            questionInput.value = '';
            btn.disabled = true;
            
            // Show flow indicator
            showFlowStep('üéØ Routing query...');
            
            // Show typing indicator
            showTypingIndicator();

            try {
                // Get detail level and agentic mode
                const detailLevel = document.querySelector('input[name="detailLevel"]:checked').value;
                const responseStyle = document.querySelector('input[name="responseStyle"]:checked').value;
                const agenticMode = document.getElementById('agenticMode').checked;
                
                // Show appropriate flow steps based on mode
                if (agenticMode) {
                    setTimeout(() => showFlowStep('üéØ Routing query...'), 300);
                    setTimeout(() => showFlowStep('üìö Retrieving documents...'), 800);
                    setTimeout(() => showFlowStep('üìä Grading quality...'), 1300);
                    setTimeout(() => showFlowStep('üí¨ Generating answer...'), 1800);
                    setTimeout(() => showFlowStep('‚úÖ Validating...'), 2300);
                } else {
                    setTimeout(() => showFlowStep('üìö Retrieving documents...'), 500);
                    setTimeout(() => showFlowStep('‚úÖ Grading relevance...'), 1000);
                    setTimeout(() => showFlowStep('üí¨ Generating answer...'), 1500);
                }
                
                // Use streaming endpoint
                const response = await fetch('http://localhost:8000/v1/query/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: question,
                        history: conversationHistory.slice(0, -1),
                        detail_level: detailLevel,
                        response_style: responseStyle,
                        use_agentic: agenticMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                removeTypingIndicator();
                hideFlowIndicator();
                
                // Create assistant message bubble for streaming
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.innerHTML = '<div class="message-content"></div>';
                document.getElementById('chatMessages').appendChild(messageDiv);
                
                const contentDiv = messageDiv.querySelector('.message-content');
                let fullAnswer = '';
                let sources = [];
                let metadata = {};
                
                // Read SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'token') {
                                fullAnswer += data.content;
                                // Format markdown in real-time
                                let formatted = fullAnswer
                                    .replace(/^# (.+)$/gm, '<h1 style="font-size: 1.4em; font-weight: 600; margin: 10px 0;">$1</h1>')
                                    .replace(/^## (.+)$/gm, '<h2 style="font-size: 1.2em; font-weight: 600; margin: 8px 0;">$1</h2>')
                                    .replace(/^### (.+)$/gm, '<h3 style="font-size: 1.1em; font-weight: 600; margin: 6px 0;">$1</h3>')
                                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                                    .replace(/^- (.+)$/gm, '<li style="margin-left: 20px;">$1</li>')
                                    .replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 10px 0;">')
                                    .replace(/\n\n/g, '</p><p style="margin: 8px 0;">')
                                    .replace(/^\n/g, '');
                                contentDiv.innerHTML = '<p style="margin: 8px 0;">' + formatted + '</p>';
                                document.getElementById('chatMessages').scrollTop = 
                                    document.getElementById('chatMessages').scrollHeight;
                            } else if (data.type === 'done') {
                                sources = data.sources || [];
                                const stepTimings = data.step_timings || {};
                                
                                const responseTime = Date.now() - startTime;
                                
                                // Add metadata badges with yellow background and step timings
                                const badgesDiv = document.createElement('div');
                                badgesDiv.className = 'metrics-box';
                                badgesDiv.style.cssText = 'background: #fff9c4; border: 2px solid #ffd54f; padding: 12px; border-radius: 10px; margin: 12px 0;';
                                
                                let metricsHTML = '<div style="font-weight: 600; margin-bottom: 8px; color: #333;">‚ö° Performance Metrics</div>';
                                metricsHTML += '<div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.8em;">';
                                
                                // Total time
                                metricsHTML += `<span style="background: #8b5cf6; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">‚è±Ô∏è Total: ${stepTimings.total || responseTime}ms</span>`;
                                
                                // Step timings
                                if (stepTimings.query_optimization) {
                                    metricsHTML += `<span style="background: #3b82f6; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">üéØ Optimize: ${stepTimings.query_optimization}ms</span>`;
                                }
                                if (stepTimings.retrieval) {
                                    metricsHTML += `<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">üìö Retrieval: ${stepTimings.retrieval}ms</span>`;
                                }
                                
                                // Web search with iterations and quality
                                if (stepTimings.web_search) {
                                    let webLabel = `üåê Web: ${stepTimings.web_search}ms`;
                                    if (stepTimings.web_iterations) {
                                        webLabel += ` (${stepTimings.web_iterations}x)`;
                                    }
                                    if (stepTimings.web_quality) {
                                        const qualityPercent = Math.round(stepTimings.web_quality * 100);
                                        webLabel += ` ${qualityPercent}%`;
                                    }
                                    metricsHTML += `<span style="background: #06b6d4; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">${webLabel}</span>`;
                                }
                                
                                if (stepTimings.prompt_building) {
                                    metricsHTML += `<span style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">üìù Prompt: ${stepTimings.prompt_building}ms</span>`;
                                }
                                if (stepTimings.llm_generation) {
                                    metricsHTML += `<span style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-weight: 600;">ü§ñ LLM: ${stepTimings.llm_generation}ms</span>`;
                                }
                                
                                metricsHTML += '</div>';
                                badgesDiv.innerHTML = metricsHTML;
                                contentDiv.appendChild(badgesDiv);
                                
                                // Extract and display confidence
                                const confidenceMatch = fullAnswer.match(/\[Confidence:\s*(HIGH|MEDIUM|LOW)\]/i);
                                if (confidenceMatch) {
                                    const confidence = confidenceMatch[1].toUpperCase();
                                    const confBar = createConfidenceBar(confidence);
                                    contentDiv.appendChild(confBar);
                                }
                            } else if (data.type === 'error') {
                                contentDiv.textContent = `‚ùå Error: ${data.message}`;
                                hideFlowIndicator();
                            }
                        }
                    }
                }
                
                // Add collapsible sources
                if (sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.style.cssText = 'margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);';
                    
                    const sourcesHeader = document.createElement('div');
                    sourcesHeader.style.cssText = 'font-weight: 600; font-size: 0.9em; color: #666; cursor: pointer; display: flex; align-items: center; gap: 8px;';
                    sourcesHeader.innerHTML = `<span id="sourcesToggle">‚ñº</span> Sources (${sources.length})`;
                    sourcesHeader.onclick = () => toggleSources();
                    
                    const sourcesList = document.createElement('div');
                    sourcesList.id = 'sourcesList';
                    sourcesList.style.cssText = 'margin-top: 10px; font-size: 0.85em; color: #666;';
                    
                    sources.forEach((s, i) => {
                        const score = s.score ? ` (${(s.score * 100).toFixed(0)}%)` : '';
                        const snippet = s.snippet ? s.snippet.substring(0, 150) + '...' : '';
                        
                        if (s.type === 'web') {
                            sourcesList.innerHTML += `
                                <div class="source-item" style="margin: 5px 0; padding-left: 15px; position: relative;">
                                    üåê <a href="${s.url}" target="_blank" style="color: white; text-decoration: none;">${s.title}</a>${score}
                                    ${snippet ? `<div class="source-tooltip">${snippet}</div>` : ''}
                                </div>`;
                        } else {
                            // Extract date from doc_id (format: 2026-02-18T22:14:17_...)
                            let docDate = '';
                            if (s.doc_id && s.doc_id.match(/^\d{4}-\d{2}-\d{2}/)) {
                                docDate = ' (' + s.doc_id.substring(0, 10) + ')';
                            }
                            
                            sourcesList.innerHTML += `
                                <div class="source-item" style="margin: 5px 0; padding-left: 15px; position: relative;">
                                    üìÑ Document${docDate}${score}
                                    ${snippet ? `<div class="source-tooltip">${snippet}</div>` : ''}
                                </div>`;
                        }
                    });
                    
                    sourcesDiv.appendChild(sourcesHeader);
                    sourcesDiv.appendChild(sourcesList);
                    contentDiv.appendChild(sourcesDiv);
                }
                
                // Add quick action buttons
                const actionsDiv = document.createElement('div');
                actionsDiv.style.cssText = 'display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;';
                actionsDiv.innerHTML = `
                    <button onclick="showMetrics()" style="padding: 6px 12px; font-size: 0.8em; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">üìä Metrics</button>
                    <button onclick="regenerateAnswer()" style="padding: 6px 12px; font-size: 0.8em; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">üîÑ Regenerate</button>
                    <button onclick="submitFeedback(1)" style="padding: 6px 12px; font-size: 0.8em; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">üëç Good</button>
                    <button onclick="submitFeedback(0)" style="padding: 6px 12px; font-size: 0.8em; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">üëé Bad</button>
                `;
                contentDiv.appendChild(actionsDiv);
                
                conversationHistory.push({ role: 'assistant', content: fullAnswer });
                
            } catch (error) {
                removeTypingIndicator();
                hideFlowIndicator();
                addMessage('assistant', `‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                questionInput.focus();
            }
        }

        function showFlowStep(text) {
            // Don't show flow indicator if backend is disconnected
            if (window.backendConnected === false) return;
            
            const indicator = document.getElementById('flowIndicator');
            const flowText = document.getElementById('flowText');
            indicator.style.display = 'block';
            flowText.textContent = text;
        }

        function hideFlowIndicator() {
            document.getElementById('flowIndicator').style.display = 'none';
        }

        function createConfidenceBar(confidence) {
            const confDiv = document.createElement('div');
            confDiv.style.cssText = 'margin: 12px 0;';
            
            const level = confidence === 'HIGH' ? 90 : confidence === 'MEDIUM' ? 60 : 30;
            const color = confidence === 'HIGH' ? '#10b981' : confidence === 'MEDIUM' ? '#f59e0b' : '#ef4444';
            
            confDiv.innerHTML = `
                <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Answer confidence: ${level}%</div>
                <div style="background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                    <div style="background: ${color}; width: ${level}%; height: 100%; transition: width 0.3s;"></div>
                </div>
            `;
            return confDiv;
        }

        function toggleSources() {
            const list = document.getElementById('sourcesList');
            const toggle = document.getElementById('sourcesToggle');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                list.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        function showMetrics() {
            alert('Detailed metrics:\n\n‚Ä¢ Route: Vector Search\n‚Ä¢ Grade Score: 0.87\n‚Ä¢ Response Time: 450ms\n‚Ä¢ Cache: Hit\n‚Ä¢ Tokens: 1,234\n‚Ä¢ Cost: $0.0025');
        }

        let isDarkMode = false;
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            
            if (isDarkMode) {
                body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
                icon.textContent = '‚òÄÔ∏è';
            } else {
                body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                icon.textContent = 'üåô';
            }
        }

        function addFeedbackButtons() {
            const chatMessages = document.getElementById('chatMessages');
            const feedbackDiv = document.createElement('div');
            feedbackDiv.style.cssText = 'display: flex; gap: 10px; margin: 10px 0; justify-content: flex-end;';
            feedbackDiv.innerHTML = `
                <button class="feedback-btn positive" onclick="submitFeedback(1)" style="padding: 8px 16px; font-size: 14px;">
                    üëç Helpful
                </button>
                <button class="feedback-btn negative" onclick="submitFeedback(-1)" style="padding: 8px 16px; font-size: 14px;">
                    üëé Not Helpful
                </button>
                <span id="feedbackMsg" style="color: #28a745; margin-left: 10px; line-height: 32px;"></span>
            `;
            chatMessages.appendChild(feedbackDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            if (!confirm('Clear conversation history?')) return;
            
            conversationHistory = [];
            document.getElementById('chatMessages').innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 15px;">ü¶â</div>
                    <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">Agentic RAG Assistant</div>
                    <div style="font-size: 0.9em; line-height: 1.6;">
                        <strong>How it works:</strong><br>
                        üéØ Route ‚Üí üìö Retrieve ‚Üí ‚úÖ Grade ‚Üí üîÑ Self-Correct ‚Üí üí¨ Generate ‚Üí üõ°Ô∏è Validate<br><br>
                        <strong>Powered by:</strong><br>
                        üìö Private documents (69 articles) ‚Ä¢ üåê Live web search ‚Ä¢ üß† Semantic cache ‚Ä¢ ‚è±Ô∏è Temporal filtering
                    </div>
                    <div style="margin-top: 20px; font-size: 0.85em; color: #bbb;">
                        Try: "What's the latest basketball news?" or "Tell me about recent events"
                    </div>
                </div>
            `;
        }

        function regenerateAnswer() {
            // Get last user question
            const lastUserMsg = conversationHistory.filter(m => m.role === 'user').pop();
            if (!lastUserMsg) {
                alert('No question to regenerate');
                return;
            }
            
            // Remove last assistant response
            conversationHistory = conversationHistory.filter(m => m !== conversationHistory[conversationHistory.length - 1]);
            
            // Remove last message from UI
            const messages = document.getElementById('chatMessages').children;
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
            
            // Set question and submit
            document.getElementById('question').value = lastUserMsg.content;
            submitQuery();
        }

        async function submitFeedback(rating) {
            if (!currentQueryId) return;
            
            const buttons = document.querySelectorAll('.feedback-btn');
            buttons.forEach(btn => btn.style.opacity = '0.5');
            
            try {
                const lastUserMessage = conversationHistory.filter(m => m.role === 'user').pop();
                
                await fetch('http://localhost:8000/v1/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: lastUserMessage?.content || '',
                        rating: rating,
                        query_id: currentQueryId
                    })
                });
                
                document.getElementById('feedbackMsg').textContent = '‚úÖ Thank you!';
            } catch (error) {
                document.getElementById('feedbackMsg').textContent = '‚ùå Failed';
            }
        }

        async function loadDocuments() {
            const docList = document.getElementById('docList');
            docList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading documents...</div>';
            
            try {
                const response = await fetch('http://localhost:8000/v1/documents?limit=50');
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    docList.innerHTML = data.documents.map(doc => `
                        <div class="doc-item" onclick="editDocumentModal('${doc.id}', \`${doc.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                            <div class="doc-id">üìÑ ${doc.id}</div>
                            <div class="doc-content">${doc.content.substring(0, 200)}...</div>
                        </div>
                    `).join('');
                } else {
                    docList.innerHTML = '<div class="loading">No documents found</div>';
                }
            } catch (error) {
                docList.innerHTML = `<div class="result error">Error loading documents: ${error.message}</div>`;
            }
        }

        async function searchDocuments() {
            const query = document.getElementById('searchDocs').value.trim();
            if (!query) return loadDocuments();
            
            const docList = document.getElementById('docList');
            docList.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/v1/documents/search?q=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    docList.innerHTML = data.results.map(doc => `
                        <div class="doc-item" onclick="editDocumentModal('${doc.id}', \`${doc.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                            <div class="doc-id">üìÑ ${doc.id}</div>
                            <div class="doc-content">${doc.content.substring(0, 200)}...</div>
                        </div>
                    `).join('');
                } else {
                    docList.innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (error) {
                docList.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function createDocument() {
            const id = document.getElementById('newDocId').value.trim();
            const content = document.getElementById('newDocContent').value.trim();
            const resultDiv = document.getElementById('createResult');
            
            if (!content) {
                resultDiv.innerHTML = '<div class="result error">Content is required</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Creating...</div>';
            
            try {
                // Try to parse as JSON for batch or metadata
                let body;
                try {
                    const parsed = JSON.parse(content);
                    if (Array.isArray(parsed)) {
                        // Batch create
                        body = { documents: parsed };
                    } else if (parsed.content) {
                        // Single with metadata
                        body = parsed;
                        if (id) body.id = id;
                    } else {
                        // Plain object, treat as content
                        body = { content: JSON.stringify(parsed) };
                        if (id) body.id = id;
                    }
                } catch {
                    // Plain text
                    body = { content };
                    if (id) body.id = id;
                }
                
                const response = await fetch('http://localhost:8000/v1/documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.documents) {
                        // Batch result
                        resultDiv.innerHTML = `<div class="result">‚úÖ Created ${data.documents.length} documents</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="result">‚úÖ Document created: ${data.document.id}</div>`;
                    }
                    document.getElementById('newDocId').value = '';
                    document.getElementById('newDocContent').value = '';
                    loadDocuments();
                } else {
                    resultDiv.innerHTML = `<div class="result error">Error: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function updateDocumentById() {
            const docId = document.getElementById('updateDocId').value.trim();
            const content = document.getElementById('updateDocContent').value.trim();
            const resultDiv = document.getElementById('updateResult');
            
            if (!docId || !content) {
                resultDiv.innerHTML = '<div class="result error">Document ID and content are required</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Updating...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/v1/documents/${docId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="result">‚úÖ Document updated: ${docId}</div>`;
                    document.getElementById('updateDocId').value = '';
                    document.getElementById('updateDocContent').value = '';
                    loadDocuments();
                } else {
                    resultDiv.innerHTML = `<div class="result error">Error: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function deleteDocumentById() {
            const docId = document.getElementById('deleteDocId').value.trim();
            const resultDiv = document.getElementById('deleteResult');
            
            if (!docId) {
                resultDiv.innerHTML = '<div class="result error">Document ID is required</div>';
                return;
            }
            
            if (!confirm(`Delete document ${docId}?`)) return;
            
            resultDiv.innerHTML = '<div class="loading">Deleting...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/v1/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="result">‚úÖ Document deleted: ${docId}</div>`;
                    document.getElementById('deleteDocId').value = '';
                    loadDocuments();
                } else {
                    resultDiv.innerHTML = `<div class="result error">Error: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        function editDocumentModal(docId, content) {
            document.getElementById('updateDocId').value = docId;
            document.getElementById('updateDocContent').value = content;
            document.querySelector('#crud-tab').scrollTop = document.querySelector('#crud-tab h3:nth-of-type(2)').offsetTop - 20;
        }

        async function updateDocument() {
            const docId = document.getElementById('editDocId').value;
            const content = document.getElementById('editDocContent').value.trim();
            const resultDiv = document.getElementById('editResult');
            
            if (!content) {
                resultDiv.innerHTML = '<div class="result error">Content is required</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Updating...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/v1/documents/${docId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="result">‚úÖ Document updated successfully!</div>';
                    setTimeout(() => {
                        closeEditModal();
                        loadDocuments();
                    }, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="result error">Error: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function deleteDocument() {
            const docId = document.getElementById('editDocId').value;
            
            if (!confirm(`Are you sure you want to delete document ${docId}?`)) return;
            
            const resultDiv = document.getElementById('editResult');
            resultDiv.innerHTML = '<div class="loading">Deleting...</div>';
            
            try {
                const response = await fetch(`http://localhost:8000/v1/documents/${docId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="result">‚úÖ Document deleted successfully!</div>';
                    setTimeout(() => {
                        closeEditModal();
                        loadDocuments();
                    }, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="result error">Error: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        async function loadLLDContent() {
            const contentDiv = document.getElementById('lldContent');
            if (contentDiv.dataset.loaded) return; // Already loaded
            
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div class="spinner"></div><br>Loading LLD document...</div>';
            
            try {
                const response = await fetch('/static/AGENTIC_RAG_LLD.md');
                const markdown = await response.text();
                
                // Protect code blocks first
                const codeBlocks = [];
                let processedMarkdown = markdown.replace(/```([\s\S]*?)```/gm, (match, code) => {
                    const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
                    codeBlocks.push(code);
                    return placeholder;
                });
                
                // Convert markdown to HTML
                let html = processedMarkdown
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/^# (.*$)/gm, '<h1 style="font-size: 2em; color: #1a1a1a; margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea;">$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2 style="font-size: 1.6em; color: #667eea; margin: 25px 0 12px 0;">$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3 style="font-size: 1.3em; color: #764ba2; margin: 20px 0 10px 0;">$1</h3>')
                    .replace(/^#### (.*$)/gm, '<h4 style="font-size: 1.1em; color: #555; margin: 15px 0 8px 0; font-weight: 600;">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1a1a1a;">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em; color: #d63384;">$1</code>')
                    .replace(/^- (.*$)/gm, '<li style="margin: 5px 0;">$1</li>')
                    .replace(/^\d+\. (.*$)/gm, '<li style="margin: 5px 0;">$1</li>')
                    .replace(/^\|(.*)\|$/gm, function(match) {
                        const cells = match.slice(1, -1).split('|').map(c => c.trim());
                        const isHeader = cells.some(c => c.includes('---'));
                        if (isHeader) return '<tr style="border-bottom: 2px solid #667eea;">' + cells.map(c => `<th style="padding: 10px; text-align: left; background: #f8f9fa; font-weight: 600;">${c}</th>`).join('') + '</tr>';
                        return '<tr style="border-bottom: 1px solid #e0e0e0;">' + cells.map(c => `<td style="padding: 10px; word-wrap: break-word; max-width: 300px;">${c}</td>`).join('') + '</tr>';
                    })
                    .replace(/(<tr[\s\S]*?<\/tr>)/g, '<table style="width: 100%; border-collapse: collapse; margin: 15px 0; overflow-x: auto; display: block;">$1</table>')
                    .replace(/\n\n/g, '<br><br>');
                
                // Restore code blocks with proper formatting
                codeBlocks.forEach((code, index) => {
                    const formattedCode = `<pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; border-left: 4px solid #667eea; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 0.85em; line-height: 1.4;"><code>${code}</code></pre>`;
                    html = html.replace(`__CODE_BLOCK_${index}__`, formattedCode);
                });
                
                contentDiv.innerHTML = html;
                contentDiv.dataset.loaded = 'true';
            } catch (error) {
                contentDiv.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">
                    <span style="font-size: 3em;">‚ö†Ô∏è</span><br><br>
                    Failed to load LLD document<br>
                    <small>${error.message}</small>
                </div>`;
            }
        }

        async function loadFeedbackStats() {
            const statsDiv = document.getElementById('feedbackStats');
            statsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Loading stats...</div>';
            
            try {
                const response = await fetch('http://localhost:8000/v1/feedback/stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                statsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${data.total}</div>
                            <div class="stat-label">Total Feedback</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.positive}</div>
                            <div class="stat-label">üëç Positive</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.negative}</div>
                            <div class="stat-label">üëé Negative</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.satisfaction_rate}%</div>
                            <div class="stat-label">Satisfaction Rate</div>
                        </div>
                    </div>
                `;
                
                renderFeedbackChart(data);
            } catch (error) {
                console.error('Feedback stats error:', error);
                statsDiv.innerHTML = `<div class="result error">
                    <strong>Error loading feedback statistics</strong><br>
                    ${error.message}<br><br>
                    <small>Make sure the backend is running on http://localhost:8000</small>
                </div>`;
            }
        }

        function renderFeedbackChart(data) {
            const ctx = document.getElementById('feedbackChart');
            
            if (feedbackChart) feedbackChart.destroy();
            
            feedbackChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative'],
                    datasets: [{
                        data: [data.positive, data.negative],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        let metricsRequestInProgress = false;

        async function loadSystemStats() {
            if (metricsRequestInProgress) {
                console.log('Metrics request already in progress, skipping...');
                return;
            }
            
            metricsRequestInProgress = true;
            
            try {
                const response = await fetch('/v1/metrics');
                const data = await response.json();
                
                // Update KPIs
                updateKPIs(data);
                
                // Update Charts
                updateCharts(data);
                
                // Update Metrics Table
                updateMetricsTable(data);
                
            } catch (error) {
                console.error('Failed to load metrics:', error);
                showError('Failed to load metrics');
            } finally {
                metricsRequestInProgress = false;
            }
        }

        function updateKPIs(data) {
            const totals = data.totals || {};
            const rates = data.rates || {};
            const window = data.window || {};
            
            // Total Queries
            document.getElementById('kpi-total-queries').textContent = totals.total_queries || 0;
            document.getElementById('kpi-queries-change').textContent = '+0%';
            
            // Avg Latency
            document.getElementById('kpi-avg-latency').textContent = Math.round(rates.avg_response_time_ms || 0) + 'ms';
            document.getElementById('kpi-latency-change').textContent = '-0%';
            
            // Success Rate
            const successRate = rates.availability_percent || 0;
            document.getElementById('kpi-success-rate').textContent = successRate.toFixed(1) + '%';
            document.getElementById('kpi-success-change').textContent = '+0%';
            
            // Cache Hit Rate (placeholder - not in current metrics)
            document.getElementById('kpi-cache-rate').textContent = '0%';
            document.getElementById('kpi-cache-change').textContent = '+0%';
        }

        let metricsCharts = {};

        function updateCharts(data) {
            const timeSeries = data.time_series || {};
            const rates = data.rates || {};
            
            // Prepare time-series data
            const queries = timeSeries.queries || [];
            const responseTimes = timeSeries.response_times || [];
            
            // Extract timestamps and values
            const timestamps = queries.map(([ts, _]) => new Date(ts).toLocaleTimeString());
            const queryValues = queries.map(([_, val]) => val);
            const latencyValues = responseTimes.map(([_, val]) => val);
            
            // Calculate success rate over time
            const errors = timeSeries.errors || [];
            const successValues = queries.map((_, idx) => {
                const errorCount = errors.filter((_, i) => i <= idx).length;
                const totalCount = idx + 1;
                return ((totalCount - errorCount) / totalCount * 100).toFixed(1);
            });
            
            // TPS Chart
            createOrUpdateChart('tpsChart', {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Queries per Second',
                        data: queryValues,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: getChartOptions('Queries/sec')
            });
            
            // Latency Chart
            createOrUpdateChart('latencyChart', {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'P50',
                            data: latencyValues.map(() => rates.p50_response_time_ms || 0),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Avg',
                            data: latencyValues,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'P99',
                            data: latencyValues.map(() => rates.p99_response_time_ms || 0),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: getChartOptions('Latency (ms)', true)
            });
            
            // Success Rate Chart
            createOrUpdateChart('successChart', {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Success Rate',
                        data: successValues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: getChartOptions('Success Rate (%)', false, 95, 100)
            });
            
            // Cache Chart (placeholder)
            createOrUpdateChart('cacheChart', {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Cache Hit Rate',
                        data: timestamps.map(() => 0),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: getChartOptions('Hit Rate (%)', false, 0, 100)
            });
            
            // Step Latency Breakdown
            const stepMetrics = data.step_metrics || {};
            const stepNames = Object.keys(stepMetrics);
            const stepAvgs = stepNames.map(name => stepMetrics[name].avg_ms || 0);
            
            createOrUpdateChart('stepLatencyChart', {
                type: 'bar',
                data: {
                    labels: stepNames.map(name => name.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Average Latency (ms)',
                        data: stepAvgs,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Latency (ms)' }
                        }
                    }
                }
            });
        }

        function createOrUpdateChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (metricsCharts[canvasId]) {
                metricsCharts[canvasId].destroy();
            }
            
            metricsCharts[canvasId] = new Chart(ctx, config);
        }

        function getChartOptions(yLabel, showLegend = false, yMin = null, yMax = null) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: showLegend,
                        position: 'top',
                        labels: { boxWidth: 12, padding: 10, font: { size: 11 } }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: yMin === null,
                        min: yMin,
                        max: yMax,
                        title: { display: true, text: yLabel }
                    },
                    x: {
                        display: false
                    }
                }
            };
        }

        function updateMetricsTable(data) {
            const stepMetrics = data.step_metrics || {};
            const tbody = document.getElementById('metricsTableBody');
            
            if (Object.keys(stepMetrics).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">No step metrics available yet</td></tr>';
                return;
            }
            
            let html = '';
            for (const [step, metrics] of Object.entries(stepMetrics)) {
                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 12px; font-weight: 500;">${step.replace(/_/g, ' ')}</td>
                        <td style="padding: 12px; text-align: right;">${metrics.avg_ms.toFixed(2)}ms</td>
                        <td style="padding: 12px; text-align: right;">${metrics.p50_ms.toFixed(2)}ms</td>
                        <td style="padding: 12px; text-align: right;">${metrics.p99_ms.toFixed(2)}ms</td>
                        <td style="padding: 12px; text-align: right;">${metrics.count}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        let currentMetricsWindow = 1;
        let autoRefreshInterval = null;
        let isTogglingRefresh = false;

        function toggleAutoRefresh() {
            if (isTogglingRefresh) return;
            isTogglingRefresh = true;
            
            const toggle = document.getElementById('autoRefreshToggle');
            
            // Clear existing interval first
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            if (toggle && toggle.checked) {
                // Start auto-refresh every 10 seconds
                autoRefreshInterval = setInterval(() => {
                    loadSystemStats();
                }, 10000);
            }
            
            isTogglingRefresh = false;
        }

        function updateMetricsWindow(hours) {
            currentMetricsWindow = hours;
            
            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.hours) === hours) {
                    btn.classList.add('active');
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#667eea';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#ddd';
                }
            });
            
            loadSystemStats();
        }

        // Start auto-refresh on page load (only if on metrics tab)
        document.addEventListener('DOMContentLoaded', () => {
            // Check backend status on load
            checkBackendStatus();
            // Check every 30 seconds
            setInterval(checkBackendStatus, 30000);
        });

        async function checkBackendStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusBox = document.getElementById('statusBox');
            
            try {
                const response = await fetch('http://localhost:8000/health', { 
                    method: 'GET',
                    timeout: 3000 
                });
                
                if (response.ok) {
                    statusIndicator.textContent = 'üü¢';
                    statusText.textContent = 'Connected';
                    statusBox.style.background = '#f0f9ff';
                    statusBox.style.borderColor = '#bae6fd';
                    statusText.style.color = '#0369a1';
                    window.backendConnected = true;
                } else {
                    throw new Error('Backend unhealthy');
                }
            } catch (error) {
                statusIndicator.textContent = 'üî¥';
                statusText.textContent = 'Disconnected';
                statusBox.style.background = '#fef2f2';
                statusBox.style.borderColor = '#fecaca';
                statusText.style.color = '#dc2626';
                window.backendConnected = false;
                // Hide flow indicator when disconnected
                document.getElementById('flowIndicator').style.display = 'none';
            }
        }

        // Original function kept for compatibility
        async function loadSystemStats_old() {
            console.log('Loading system stats...');
            
            // Generate time labels (last 60 minutes)
            const labels = Array.from({length: 60}, (_, i) => `${59-i}m`);
            
            // Generate sample data with some variation
            const generateSampleData = (base, variance) => {
                return Array.from({length: 60}, () => base + Math.random() * variance);
            };
            
            // TPS Chart
            const tpsCtx = document.getElementById('tpsChart');
            console.log('TPS Canvas:', tpsCtx);
            if (tpsCtx) {
                if (window.tpsChart) window.tpsChart.destroy();
                window.tpsChart = new Chart(tpsCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Queries per Second',
                                data: generateSampleData(5, 3),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Queries/sec' }
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
                // Availability Chart
                const availCtx = document.getElementById('availabilityChart');
                if (availCtx) {
                    if (window.availabilityChart) window.availabilityChart.destroy();
                    window.availabilityChart = new Chart(availCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Availability',
                                data: generateSampleData(99, 1),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    min: 95,
                                    max: 100,
                                    title: { display: true, text: 'Availability %' }
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
                // Latency Chart (P50, P99, Avg)
                const latencyCtx = document.getElementById('latencyChart');
                if (latencyCtx) {
                    if (window.latencyChart) window.latencyChart.destroy();
                    window.latencyChart = new Chart(latencyCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'P50 Latency',
                                    data: generateSampleData(150, 30),
                                    borderColor: '#8b5cf6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    tension: 0.4,
                                    borderWidth: 2
                                },
                                {
                                    label: 'Avg Latency',
                                    data: generateSampleData(200, 40),
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    borderWidth: 2
                                },
                                {
                                    label: 'P99 Latency',
                                    data: generateSampleData(350, 80),
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    tension: 0.4,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Latency (ms)' }
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                }
        }
        
        function renderOverviewCharts(timeSeries) {
            if (!timeSeries.queries || timeSeries.queries.length === 0) {
                return '<div style="margin-top: 20px; text-align: center; opacity: 0.7;">No time-series data yet. Start querying to see charts!</div>';
            }
            
            return `
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">üìà Time Series Overview (Last 1 Hour)</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="chart-container">
                            <h5>Throughput (Queries)</h5>
                            ${renderLineChart(timeSeries.queries, '#8b5cf6', 'count')}
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">
                                Total: ${timeSeries.queries.length} queries
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h5>Response Time (ms)</h5>
                            ${renderLineChart(timeSeries.response_times, '#3b82f6', 'latency')}
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">
                                Avg: ${(timeSeries.response_times.reduce((sum, [_, val]) => sum + val, 0) / timeSeries.response_times.length).toFixed(0)}ms
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h5>Web Searches</h5>
                            ${renderLineChart(timeSeries.web_searches, '#10b981', 'count')}
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">
                                Total: ${timeSeries.web_searches.length} web searches
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h5>Errors</h5>
                            ${renderLineChart(timeSeries.errors, '#ef4444', 'count')}
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">
                                Total: ${timeSeries.errors.length} errors
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderLineChart(data, color, type) {
            if (!data || data.length === 0) {
                return '<div style="height: 100px; display: flex; align-items: center; justify-content: center; opacity: 0.5;">No data</div>';
            }
            
            const width = 100;
            const height = 100;
            const padding = 15;
            
            if (type === 'count') {
                // For count data, show cumulative
                const points = data.map((_, i) => {
                    const x = (i / (data.length - 1)) * (width - 2 * padding) + padding;
                    const y = height - padding - ((i + 1) / data.length) * (height - 2 * padding);
                    return `${x},${y}`;
                }).join(' ');
                
                return `
                    <svg width="100%" height="${height}" style="background: rgba(0,0,0,0.1); border-radius: 8px;">
                        <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2.5" />
                        <text x="5" y="15" fill="rgba(255,255,255,0.5)" font-size="10">${data.length}</text>
                        <text x="5" y="${height - 5}" fill="rgba(255,255,255,0.5)" font-size="10">0</text>
                    </svg>
                `;
            } else {
                // For latency data
                const values = data.map(([_, val]) => val);
                const max = Math.max(...values);
                const min = Math.min(...values);
                const range = max - min || 1;
                
                const points = values.map((val, i) => {
                    const x = (i / (values.length - 1)) * (width - 2 * padding) + padding;
                    const y = height - padding - ((val - min) / range) * (height - 2 * padding);
                    return `${x},${y}`;
                }).join(' ');
                
                return `
                    <svg width="100%" height="${height}" style="background: rgba(0,0,0,0.1); border-radius: 8px;">
                        <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2.5" />
                        <text x="5" y="15" fill="rgba(255,255,255,0.5)" font-size="10">${max.toFixed(0)}</text>
                        <text x="5" y="${height - 5}" fill="rgba(255,255,255,0.5)" font-size="10">${min.toFixed(0)}</text>
                    </svg>
                `;
            }
        }
        
        function renderStepMetrics(stepMetrics) {
            if (!stepMetrics || Object.keys(stepMetrics).length === 0) {
                return '';
            }
            
            const steps = Object.entries(stepMetrics).sort((a, b) => b[1].avg_ms - a[1].avg_ms);
            
            return `
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">‚ö° Pipeline Steps Performance (Last 1 Hour)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        ${steps.map(([step, metrics]) => {
                            const stepNames = {
                                'query_optimization': 'üîÑ Query Optimization',
                                'context_building': 'üí¨ Context Building',
                                'web_search': 'üåê Web Search',
                                'prompt_building': 'üìù Prompt Building',
                                'retrieval': 'üìö Retrieval',
                                'reranking': 'üéØ Reranking',
                                'llm_generation': 'ü§ñ LLM Generation'
                            };
                            const displayName = stepNames[step] || step.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            
                            return `
                            <div class="chart-container">
                                <h5>${displayName}</h5>
                                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                                    <div>
                                        <div style="font-size: 1.3em; font-weight: bold; color: #3b82f6;">${metrics.avg_ms}ms</div>
                                        <div style="font-size: 0.75em; opacity: 0.7;">Average</div>
                                    </div>
                                    <div style="text-align: right; font-size: 0.85em;">
                                        <div>P50: <strong>${metrics.p50_ms}ms</strong></div>
                                        <div>P99: <strong style="color: #f59e0b;">${metrics.p99_ms}ms</strong></div>
                                    </div>
                                </div>
                                ${renderStepLineChart(metrics.time_series || [], step)}
                                <div style="margin-top: 8px; font-size: 0.75em; opacity: 0.6; text-align: center;">
                                    ${metrics.count} samples
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderStepLineChart(timeSeries, stepName) {
            if (!timeSeries || timeSeries.length === 0) {
                return '<div style="height: 80px; display: flex; align-items: center; justify-content: center; opacity: 0.5; font-size: 0.85em;">No data</div>';
            }
            
            const values = timeSeries.map(([_, val]) => val);
            const max = Math.max(...values);
            const min = Math.min(...values);
            const range = max - min || 1;
            
            const width = 100;
            const height = 80;
            const padding = 10;
            
            const points = values.map((val, i) => {
                const x = (i / (values.length - 1)) * (width - 2 * padding) + padding;
                const y = height - padding - ((val - min) / range) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');
            
            // Color based on step type
            const colors = {
                'query_optimization': '#a855f7',
                'context_building': '#10b981',
                'web_search': '#3b82f6',
                'prompt_building': '#8b5cf6',
                'retrieval': '#f59e0b',
                'reranking': '#ef4444',
                'llm_generation': '#ec4899'
            };
            const color = colors[stepName] || '#6b7280';
            
            return `
                <svg width="100%" height="${height}" style="background: rgba(0,0,0,0.1); border-radius: 8px;">
                    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2.5" />
                    <text x="5" y="15" fill="rgba(255,255,255,0.5)" font-size="10">${max.toFixed(0)}ms</text>
                    <text x="5" y="${height - 5}" fill="rgba(255,255,255,0.5)" font-size="10">${min.toFixed(0)}ms</text>
                </svg>
            `;
        }
        
        function renderTimeSeriesCharts(timeSeries) {
            // This function is no longer needed as we have renderOverviewCharts
            return '';
        }
        
        function renderResponseTimeChart(data) {
            // Deprecated - using renderLineChart instead
            return '';
        }

        // Keyboard shortcuts
        document.getElementById('question').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitQuery();
            }
        });
        
        document.getElementById('searchDocs').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchDocuments();
            }
        });
    </script>
    <script src="/static/presentation.js"></script>
</body>
</html>
